---
title: Deploying ASP.NET Core to App Service on Linux
date: 2017-06-19T09:00:13+02:00
author: Jan Hajek
permalink: /2017/06/19/deploying-asp-net-core-to-app-service-on-linux/
categories:
  - Microsoft
  - Microsoft Azure
  - Open Source
tags:
  - App Service on Linux
  - ASP.NET Core
  - Azure Web Apps
  - Containers
  - Continuous Integration
  - Docker
format: aside
---

<p>When you attempt to deploy an ASP.NET Core project to App Service on Linux, you may run into an error during the build process -&nbsp;<em>Object reference not set to an instance of an object</em>. When you try to deploy the project to App Service on Windows, everything works, so where is the issue?</p>

<!--more-->

<p>So apparently, when you include a Solution (<em>.sln</em>) file with your project, Kudu is going to have a hard time to parse it on App Service on Linux since it requires to load some assemblies to parse the .sln, however those are not present on ASL yet. There are multiple ways to go around this:</p>

<p>You can either remove the .sln file from the whole repository, which will result in the build to succeed, the application will deploy and we are safe and sound, however, it will be harder to use Visual Studio, since it kind of requires the solution file to be present.</p>

<p>If you don't want to do that, you can include a <a href="https://github.com/projectkudu/kudu/wiki/Custom-Deployment-Script">custom deployment script</a> with your code by adding a&nbsp;<em>.deployment</em> file into the project's root and specifying the deployment script in it:</p>

```ini
[config]
command = deploy.sh
```

<p>Then you need to also include the&nbsp;<em>deploy.sh</em> script along with the&nbsp;<em>.deployment</em> file, the script can look like this (this is what gets autogenerated when you don't include the solution file, don't forget to rename the&nbsp;<em>WebApplication1</em> to your&nbsp;<em>.csproj</em>):</p>

```bash
#!/bin/bash

# ----------------------
# KUDU Deployment Script
# Version: 1.0.13
# ----------------------

# Helpers
# -------

exitWithMessageOnError () {
  if [ ! $? -eq 0 ]; then
    echo "An error has occurred during web site deployment."
    echo $1
    exit 1
  fi
}

# Prerequisites
# -------------

# Verify node.js installed
hash node 2>/dev/null
exitWithMessageOnError "Missing node.js executable, please install node.js, if already installed make sure it can be reached from current environment."

# Setup
# -----

SCRIPT_DIR="${BASH_SOURCE[0]%\\*}"
SCRIPT_DIR="${SCRIPT_DIR%/*}"
ARTIFACTS=$SCRIPT_DIR/../artifacts
KUDU_SYNC_CMD=${KUDU_SYNC_CMD//\"}

if [[ ! -n "$DEPLOYMENT_SOURCE" ]]; then
  DEPLOYMENT_SOURCE=$SCRIPT_DIR
fi

if [[ ! -n "$NEXT_MANIFEST_PATH" ]]; then
  NEXT_MANIFEST_PATH=$ARTIFACTS/manifest

  if [[ ! -n "$PREVIOUS_MANIFEST_PATH" ]]; then
    PREVIOUS_MANIFEST_PATH=$NEXT_MANIFEST_PATH
  fi
fi

if [[ ! -n "$DEPLOYMENT_TARGET" ]]; then
  DEPLOYMENT_TARGET=$ARTIFACTS/wwwroot
else
  KUDU_SERVICE=true
fi

if [[ ! -n "$KUDU_SYNC_CMD" ]]; then
  # Install kudu sync
  echo Installing Kudu Sync
  npm install kudusync -g --silent
  exitWithMessageOnError "npm failed"

  if [[ ! -n "$KUDU_SERVICE" ]]; then
    # In case we are running locally this is the correct location of kuduSync
    KUDU_SYNC_CMD=kuduSync
  else
    # In case we are running on kudu service this is the correct location of kuduSync
    KUDU_SYNC_CMD=$APPDATA/npm/node_modules/kuduSync/bin/kuduSync
  fi
fi

if [ "x$DEPLOYMENT_TEMP" = x ]; then
    DEPLOYMENT_TEMP=/tmp/`date +%s`
    CLEAN_LOCAL_DEPLOYMENT_TEMP=true
fi

if [ "x$CLEAN_LOCAL_DEPLOYMENT_TEMP" = xtrue ]; then
    rm -rf "$DEPLOYMENT_TEMP"
    mkdir "$DEPLOYMENT_TEMP"
fi
##################################################################################################################################
# Deployment
# ----------

echo Handling ASP.NET Core Web Application deployment.

# 1. Restore nuget packages
dotnet restore "WebApplication1/WebApplication1.csproj"
exitWithMessageOnError "dotnet restore failed"

# 2. Build and publish
dotnet publish "WebApplication1/WebApplication1.csproj" --output "$DEPLOYMENT_TEMP" --configuration Release
exitWithMessageOnError "dotnet publish failed"

# 3. KuduSync
"$KUDU_SYNC_CMD" -v 50 -f "$DEPLOYMENT_TEMP" -t "$DEPLOYMENT_TARGET" -n "$NEXT_MANIFEST_PATH" -p "$PREVIOUS_MANIFEST_PATH" -i ".git;.hg;.deployment;deploy.sh"
exitWithMessageOnError "Kudu Sync failed"


##################################################################################################################################
echo "Finished successfully."
```

<p>And last, but not least, you can build the source code somewhere else, like in Visual Studio Team Services, and then just publish it to he App Service on Linux.</p>

<p>Additionally, it is quite important to mention, that you will need to set the startup command for the container in order for the application to start successfully, else it is going to <a href="https://github.com/Azure-App-Service/dotnetcore/blob/master/1.1/init_container.sh#L13">attempt searching for&nbsp;<em>.csproj</em> in the root</a>, which it won't be able to find and therefore the container will keep crashing (you will see it in the logs). The startup command will look like this:&nbsp;<em>dotnet /home/site/wwwroot/WebApplication1.dll</em></p>
<figure class="wp-block-image"><img src="/uploads/2017/06/startupcommand_dotnetcore.png" alt="startupcommand_dotnetcore" class="wp-image-359"/></figure>
